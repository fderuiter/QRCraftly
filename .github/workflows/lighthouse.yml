name: Lighthouse

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      - name: Run Lighthouse CI
        id: lighthouse_audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
      - name: Post Lighthouse Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          LINKS: ${{ steps.lighthouse_audit.outputs.links }}
          MANIFEST: ${{ steps.lighthouse_audit.outputs.manifest }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const links = process.env.LINKS ? JSON.parse(process.env.LINKS) : {};
            const manifest = process.env.MANIFEST ? JSON.parse(process.env.MANIFEST) : [];

            if (!manifest || manifest.length === 0) {
               core.setFailed('Lighthouse MANIFEST is missing or empty. Please check the Lighthouse CI action logs.');
               return;
            }

            const formatScore = (score) => Math.round(score * 100);
            const scoreIcon = (score) => score >= 0.9 ? 'ðŸŸ¢' : score >= 0.5 ? 'ðŸŸ ' : 'ðŸ”´';

            let comment = '## âš¡ï¸ Lighthouse Report\n\n';

            manifest.forEach((result) => {
              const summary = result.summary;
              const reportUrl = links[result.url];

              comment += `### URL: ${result.url}\n`;
              if (reportUrl) comment += `[View Full Report](${reportUrl})\n\n`;

              comment += '| Category | Score |\n';
              comment += '| --- | --- |\n';

              ['performance', 'accessibility', 'best-practices', 'seo', 'pwa'].forEach(key => {
                if (summary[key] !== undefined) {
                  const score = summary[key];
                  comment += `| ${key} | ${scoreIcon(score)} ${formatScore(score)} |\n`;
                }
              });
              comment += '\n';
            });

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
